<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Diagnostic Tool - AIFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-12 px-4">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">CORS Diagnostic Tool</h1>
                <p class="text-gray-600 mb-8">Test CORS configuration between frontend and backend</p>

                <div class="space-y-6">
                    <!-- Backend URL Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Backend API URL:</label>
                        <input 
                            type="text" 
                            id="backendUrl" 
                            value="https://aiflowbackend-production.up.railway.app/api/v1"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <!-- Test Buttons -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button 
                            onclick="testHealth()" 
                            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                        >
                            Test Health Endpoint
                        </button>
                        <button 
                            onclick="testCORSDiagnostic()" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                        >
                            Test CORS Diagnostic
                        </button>
                        <button 
                            onclick="testLogin()" 
                            class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                        >
                            Test Login Endpoint
                        </button>
                    </div>

                    <!-- Results -->
                    <div id="results" class="hidden">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Test Results:</h2>
                        <div id="resultsContent" class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                            <!-- Results will be inserted here -->
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="mt-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-900 mb-3">How to Fix CORS Errors:</h3>
                        <ol class="list-decimal list-inside space-y-2 text-blue-800">
                            <li>Go to Railway Dashboard → Backend Service → <strong>Variables</strong> tab</li>
                            <li>Add: <code class="bg-blue-100 px-2 py-1 rounded">FRONTEND_URL = https://airflow-frontend.vercel.app</code></li>
                            <li>Add: <code class="bg-blue-100 px-2 py-1 rounded">BACKEND_URL = https://aiflowbackend-production.up.railway.app</code></li>
                            <li>Wait 2-3 minutes for Railway to redeploy</li>
                            <li>Click "Test CORS Diagnostic" above to verify</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getBackendUrl() {
            return document.getElementById('backendUrl').value;
        }

        function showResults(title, data, success = true) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsDiv.classList.remove('hidden');
            
            const statusColor = success ? 'green' : 'red';
            const statusIcon = success ? '✓' : '✗';
            
            resultsContent.innerHTML = `
                <div class="mb-4">
                    <span class="text-2xl font-bold text-${statusColor}-600">${statusIcon}</span>
                    <span class="ml-2 text-lg font-semibold text-gray-900">${title}</span>
                </div>
                <pre class="bg-white p-4 rounded border overflow-x-auto text-sm">${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        async function testHealth() {
            const backendUrl = getBackendUrl();
            console.log('Testing health endpoint:', backendUrl + '/health/');
            
            try {
                const response = await fetch(backendUrl + '/health/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                showResults('Health Check Success', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: {
                        'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                        'access-control-allow-credentials': response.headers.get('access-control-allow-credentials'),
                    },
                    data: data
                }, true);
            } catch (error) {
                showResults('Health Check Failed', {
                    error: error.message,
                    type: error.name,
                    suggestion: 'This might be a CORS error. Check Railway environment variables.'
                }, false);
            }
        }

        async function testCORSDiagnostic() {
            const backendUrl = getBackendUrl();
            console.log('Testing CORS diagnostic:', backendUrl + '/cors-diagnostic/');
            
            try {
                const response = await fetch(backendUrl + '/cors-diagnostic/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                showResults('CORS Diagnostic Success', {
                    status: response.status,
                    statusText: response.statusText,
                    corsHeaders: {
                        'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                        'access-control-allow-credentials': response.headers.get('access-control-allow-credentials'),
                        'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                    },
                    diagnostic: data
                }, true);
            } catch (error) {
                showResults('CORS Diagnostic Failed', {
                    error: error.message,
                    type: error.name,
                    suggestion: 'Set FRONTEND_URL and BACKEND_URL in Railway environment variables'
                }, false);
            }
        }

        async function testLogin() {
            const backendUrl = getBackendUrl();
            console.log('Testing login endpoint (OPTIONS):', backendUrl + '/auth/login/');
            
            try {
                // First test OPTIONS (preflight)
                const optionsResponse = await fetch(backendUrl + '/auth/login/', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type',
                    },
                });
                
                showResults('Login OPTIONS Preflight', {
                    status: optionsResponse.status,
                    statusText: optionsResponse.statusText,
                    headers: {
                        'access-control-allow-origin': optionsResponse.headers.get('access-control-allow-origin'),
                        'access-control-allow-credentials': optionsResponse.headers.get('access-control-allow-credentials'),
                        'access-control-allow-methods': optionsResponse.headers.get('access-control-allow-methods'),
                        'access-control-allow-headers': optionsResponse.headers.get('access-control-allow-headers'),
                    },
                    message: optionsResponse.status === 200 ? 'CORS preflight successful!' : 'CORS preflight failed'
                }, optionsResponse.status === 200);
            } catch (error) {
                showResults('Login OPTIONS Failed', {
                    error: error.message,
                    type: error.name,
                    suggestion: 'CORS preflight is failing. Add FRONTEND_URL to Railway environment variables.'
                }, false);
            }
        }

        // Auto-run health check on load
        window.addEventListener('load', () => {
            console.log('CORS Diagnostic Tool loaded');
            console.log('Frontend origin:', window.location.origin);
        });
    </script>
</body>
</html>
